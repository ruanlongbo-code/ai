# AiProtect —— AI 驱动的智能测试平台

## 一、项目概述

AiProtect 是一款基于大语言模型（LLM）和智能体（Agent）技术打造的 **AI 驱动智能测试平台**，旨在通过 AI 能力深度融合软件测试全流程，实现测试用例的自动生成、自动执行和智能管理，大幅提升测试效率与质量。

---

## 二、解决什么问题

### 2.1 传统测试面临的痛点

| 痛点 | 描述 |
|------|------|
| **用例编写耗时** | 手工编写功能测试用例需要大量时间，且容易遗漏边界场景和异常场景，覆盖率难以保证 |
| **接口测试门槛高** | 接口自动化测试需要测试人员具备编程能力，编写和维护接口用例成本高 |
| **用例维护困难** | 随着需求迭代，测试用例需要频繁更新，手工维护效率低下 |
| **测试覆盖率不足** | 人工设计用例容易产生思维盲区，难以系统性覆盖所有测试点 |
| **UI 自动化成本高** | UI 自动化测试脚本编写复杂，页面变动后维护成本极大 |
| **知识经验难传承** | 测试经验依赖个人，人员变动导致测试质量波动 |

### 2.2 AiProtect 如何解决

- **AI 自动生成测试用例**：基于需求文档 / 接口文档，由 AI 自动提取测试点、生成覆盖完整的功能测试用例和接口测试用例，消除人工编写的遗漏和低效
- **AI 智能执行与验证**：AI 不仅生成用例，还能自动执行接口测试并验证结果，实现"需求 → 用例 → 执行 → 报告"的全链路自动化
- **知识库驱动的测试设计**：通过 RAG（检索增强生成）技术将需求文档、接口文档沉淀为知识库，AI 基于知识库进行精准的用例生成，保证用例与业务的高度一致性
- **覆盖率闭环保障**：工作流中内置覆盖率验证节点，自动检查生成的测试点和用例是否覆盖全部需求，未覆盖则自动补充，确保高覆盖率

---

## 三、核心功能模块

### 3.1 功能用例生成

**功能描述**：基于需求文档，利用 AI 自动生成功能测试用例。

**工作流程**：

```
需求文档 → [提取测试点] → [验证测试点覆盖率] → (未覆盖？补充测试点) 
        → [生成测试用例] → [验证用例覆盖率] → (未覆盖？补充用例) → [保存到数据库]
```

**技术实现**：
- 使用 **LangGraph** 构建状态机工作流（`GeneratorTestCaseWorkflow`），包含子工作流 `GeneratorPointWorkflow`
- **子工作流**：需求文档 → 测试点提取 → 覆盖率验证 → 循环补充直至 100% 覆盖
- **主工作流**：测试点 → 测试用例生成 → 用例覆盖率验证 → 循环补充直至全部覆盖 → 保存到数据库
- 前端通过 **SSE（Server-Sent Events）** 实时展示 AI 生成过程，支持 ChatGPT 风格的流式输出
- 生成的用例自动保存到 `functional_case` 表，关联对应需求

**AI Agent 工具链**：
- `search_requirement`：从 RAG 知识库检索需求文档
- `generator_case`：调用用例生成工作流

### 3.2 AI 执行用例

**功能描述**：AI 生成的接口测试用例可直接自动执行，支持单用例执行、测试套件执行、测试任务执行三种粒度。

**执行层级**：

```
测试任务 (Task) 
  └── 测试套件 (Suite) 
        └── 测试用例 (Case) → 执行引擎 → 执行结果 & 报告
```

**技术实现**：
- **执行引擎**（`TestExecutor`）：
  - 支持前置依赖接口的自动调用和数据提取
  - 支持前后置脚本（Python `exec` 动态执行）
  - 支持变量替换（`${{变量名}}` 语法引用测试环境数据）
  - 支持多种请求格式（JSON、Form、XML、文件上传）
  - 支持多种断言方式（HTTP 状态码、字段值相等、非空校验等，基于 JMESPath 表达式提取）
  - 支持数据库校验（连接被测系统数据库进行数据验证）
- **执行模式**：
  - 同步执行：单用例/套件实时返回结果
  - **后台异步执行**：测试任务通过 FastAPI `BackgroundTasks` 后台执行，前端轮询查看执行状态
- **结果记录**：每次执行的结果（状态、日志、请求/响应数据、耗时等）持久化到数据库，支持历史记录查询和执行报告

### 3.3 接口用例生成 & 接口自动化

**功能描述**：基于接口文档（OpenAPI / Swagger），AI 自动生成基础测试用例，再进一步生成可直接执行的接口自动化用例。

**工作流程**：

```
接口文档 → [生成基础用例] → [验证覆盖率] → (未覆盖？补充用例)
        → [遍历基础用例] → [生成可执行用例] → [预执行验证] → (失败？重新生成) → [保存到数据库]
```

**技术实现**：
- **第一阶段 - 基础用例生成**（`ApiBaseCaseGeneratorWorkFlow`）：
  - AI 基于接口文档分析接口的功能点和测试场景
  - 自动生成基础用例（包含用例名称、测试步骤、预期结果、前置依赖）
  - 内置覆盖率验证，未达 100% 自动补充生成
- **第二阶段 - 可执行用例生成**（`ApiRunCaseGeneratorWorkFlow`）：
  - 加载可用的工具函数列表和测试文件列表
  - AI 基于基础用例和测试环境配置，生成包含完整请求数据（URL、Headers、Body、Params）、断言规则的结构化可执行用例
  - **预执行验证**：自动执行生成的用例，验证其可用性；执行失败则重新生成（最多 3 次）
  - 验证通过后保存到数据库，标记为 `ready` 状态
- **接口文档解析**（`utils/parser`）：支持 OpenAPI 3.0 和 Swagger 2.0 格式的接口文档解析，提取接口路径、方法、参数、请求体、响应体等结构化信息
- **RAG 知识库**：通过 LightRAG + RAGAnything 将接口文档存入知识库，支持多模态文档（含图片、表格），Agent 可以通过自然语言检索接口信息
- **多 Agent 协作**（`AgentManage`）：
  - `case_generator_agent`：功能用例生成智能体
  - `api_case_generator_agent`：接口用例生成智能体
  - `supervisor`：主管 Agent，根据用户意图路由到对应的子 Agent

### 3.4 UI 自动化（开发中）

**功能描述**：基于页面对象模型（Page Object Model），管理 UI 测试页面和 UI 测试用例，支持 UI 自动化测试。

**当前状态**：功能模块已搭建（页面管理、用例管理），核心自动化执行能力正在由其他团队成员开发中。

**规划能力**：
- UI 页面元素管理和维护
- 基于页面对象模型的 UI 测试用例设计
- AI 辅助生成 UI 自动化测试脚本
- UI 自动化执行与结果报告

---

## 四、技术方案

### 4.1 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                        前端 (Vue 3)                          │
│  Element Plus + Vue Router + Pinia + ECharts + CodeMirror   │
│                   Vite 构建  |  SSE 流式交互                  │
└──────────────────────────┬──────────────────────────────────┘
                           │  Nginx 反向代理
┌──────────────────────────▼──────────────────────────────────┐
│                    后端 (FastAPI + Python 3.11)               │
│                                                              │
│  ┌──────────────┐  ┌──────────────┐  ┌───────────────────┐  │
│  │  业务服务层    │  │  AI 智能体层  │  │  工作流引擎层      │  │
│  │              │  │              │  │                   │  │
│  │ - 用户管理    │  │ - 功能用例    │  │ - 测试点生成工作流  │  │
│  │ - 项目管理    │  │   生成 Agent  │  │ - 功能用例生成工作流│  │
│  │ - 测试环境    │  │ - 接口用例    │  │ - 基础用例生成工作流│  │
│  │ - 功能测试    │  │   生成 Agent  │  │ - 可执行用例生成   │  │
│  │ - 接口测试    │  │ - Supervisor  │  │   工作流           │  │
│  │ - 测试管理    │  │   多Agent协作  │  │ - 覆盖率验证工作流  │  │
│  │ - 测试执行    │  │              │  │                   │  │
│  └──────────────┘  └──────────────┘  └───────────────────┘  │
│                                                              │
│  ┌──────────────┐  ┌──────────────┐  ┌───────────────────┐  │
│  │  RAG 知识库   │  │  用例执行引擎 │  │   MCP 工具服务     │  │
│  │              │  │              │  │                   │  │
│  │ - LightRAG   │  │ - HTTP 请求   │  │ - 需求检索        │  │
│  │ - RAGAnything │  │ - 变量替换    │  │ - 用例生成        │  │
│  │ - Embedding   │  │ - 脚本执行    │  │ - 接口文档检索     │  │
│  │ - Rerank      │  │ - 断言验证    │  │ - 环境数据加载     │  │
│  │ - 多模态理解   │  │ - 数据库校验  │  │                   │  │
│  └──────────────┘  └──────────────┘  └───────────────────┘  │
└──────────────────────────┬──────────────────────────────────┘
                           │
┌──────────────────────────▼──────────────────────────────────┐
│                     数据与基础设施层                           │
│                                                              │
│  MySQL 8.0 (Tortoise ORM)  |  LangSmith (可观测性)           │
│  Docker Compose 容器化部署   |  Gunicorn + Uvicorn (部署)     │
└─────────────────────────────────────────────────────────────┘
```

### 4.2 技术栈明细

| 层级 | 技术 | 说明 |
|------|------|------|
| **前端** | Vue 3 + Vite 7 | 现代化 SPA 前端框架 |
| | Element Plus | UI 组件库 |
| | Pinia | 状态管理 |
| | Vue Router | 前端路由 |
| | ECharts | 数据可视化（测试报告图表） |
| | CodeMirror / Monaco Editor | 代码编辑器（脚本编写、JSON 编辑） |
| | Axios + SSE | HTTP 请求与流式数据交互 |
| **后端** | Python 3.11 + FastAPI | 高性能异步 Web 框架 |
| | Tortoise ORM + MySQL 8 | 异步 ORM 数据库访问 |
| | Gunicorn + Uvicorn | 生产级 ASGI 服务器 |
| | PyJWT + Bcrypt | JWT 认证与密码加密 |
| **AI / LLM** | LangChain + LangGraph | LLM 应用框架与工作流编排 |
| | LangGraph Supervisor | 多 Agent 协作框架 |
| | LangSmith | LLM 调用可观测性与调试 |
| | LightRAG + RAGAnything | RAG 知识库（支持多模态文档） |
| | OpenAI API (兼容接口) | 大模型调用（支持硅基流动等国产模型） |
| **测试执行** | Requests + JMESPath | HTTP 请求发送与响应数据提取 |
| | Faker | 随机测试数据生成 |
| | PyMySQL | 数据库连接与验证 |
| | Allure + Pytest | 测试报告生成 |
| **部署** | Docker + Docker Compose | 容器化一键部署 |
| | Nginx | 静态文件服务 + API 反向代理 |

### 4.3 数据模型

```
项目 (Project)
  ├── 模块 (Module)
  ├── 成员 (ProjectMember)
  ├── 测试环境 (TestEnvironment)
  │     ├── 环境变量 (TestEnvironmentConfig)
  │     └── 数据库配置 (TestEnvironmentDb)
  ├── 功能测试
  │     ├── 需求 (Requirement)
  │     └── 功能用例 (FunctionalCase)
  ├── 接口测试
  │     ├── 接口 (Interface)
  │     ├── 基础用例 (ApiBaseCase)
  │     ├── 接口测试用例 (ApiTestCase)
  │     └── 接口依赖 (DependencyGroup / DependencyItem)
  └── 测试管理 & 执行
        ├── 测试任务 (TestTask)
        ├── 测试套件 (TestSuite)
        ├── 任务-套件关联 (TaskSuiteRelation)
        ├── 套件-用例关联 (SuiteCaseRelation)
        ├── 任务运行记录 (TestTaskRun)
        ├── 套件运行记录 (TestSuiteRun)
        └── 用例运行记录 (ApiCaseRun)
```

### 4.4 AI 工作流设计亮点

1. **覆盖率闭环验证**：每个工作流都内置覆盖率验证节点，AI 生成的测试点/用例必须通过覆盖率审查，未通过则自动循环补充，确保质量
2. **预执行验证机制**：接口用例生成后自动预执行，验证用例可用性，不可用则重新生成（最多 3 次重试），确保生成的用例是真正可执行的
3. **子工作流嵌套**：通过 LangGraph 的子图（Subgraph）机制实现工作流嵌套，如主工作流调用测试点生成子工作流，结构清晰可维护
4. **流式输出体验**：全程基于 SSE 流式推送 AI 生成进度，前端以 ChatGPT 风格实时展示，用户体验流畅
5. **多 Agent 协作**：通过 Supervisor 模式实现多 Agent 协作，用户只需自然语言描述需求，系统自动路由到合适的 Agent 处理

---

## 五、业务价值说明

### 5.1 效率提升

| 场景 | 传统方式 | 使用 AiProtect | 提升倍率 |
|------|---------|----------------|---------|
| 功能用例编写 | 1 个中等需求约 2-4 小时 | AI 自动生成约 2-5 分钟 | **约 30-50 倍** |
| 接口用例设计 | 1 个接口约 1-2 小时 | AI 自动生成约 1-3 分钟 | **约 30-40 倍** |
| 接口自动化脚本 | 1 个接口约 2-4 小时 | AI 生成可执行用例约 3-5 分钟 | **约 40-50 倍** |
| 回归测试执行 | 人工执行半天到 1 天 | 自动化执行数分钟 | **约 100+ 倍** |

### 5.2 质量保障

- **更高的覆盖率**：AI 系统化分析需求/接口文档，结合覆盖率验证循环，覆盖率显著高于人工设计
- **减少人为遗漏**：AI 不会"遗忘"边界场景和异常场景，确保测试完整性
- **用例可用性保障**：接口用例经过预执行验证，确保生成即可用，避免"只能看不能跑"的尴尬
- **标准化输出**：AI 生成的用例格式统一、规范，便于团队协作和审查

### 5.3 成本节约

- **降低人力成本**：AI 承担大量重复性的测试设计和编写工作，测试团队可聚焦于更高价值的探索性测试和策略制定
- **缩短交付周期**：测试准备时间大幅缩短，加速项目交付节奏
- **降低技术门槛**：不需要测试人员具备编程能力即可获得接口自动化用例，降低团队技术门槛
- **减少维护成本**：需求变更时只需重新触发 AI 生成，无需人工逐条修改用例

### 5.4 知识沉淀

- **需求文档知识化**：通过 RAG 将需求文档和接口文档沉淀为可检索的知识库，测试设计不再依赖个人记忆
- **测试经验标准化**：AI 的提示词（Prompt）中内置了测试设计的最佳实践，确保每次生成都符合专业标准
- **可追溯的测试历史**：所有执行记录、测试报告持久化存储，支持回溯和分析

### 5.5 团队赋能

- **项目级管理**：支持多项目管理，每个项目独立的模块、成员、环境配置
- **角色权限控制**：管理员、项目负责人、编辑、查看等多级权限，保障数据安全
- **测试资产管理**：测试计划、测试套件、测试用例全生命周期管理
- **可视化测试报告**：任务/套件级执行报告，支持通过/失败/错误/跳过等多维度统计

---

## 六、项目结构

```
ai/ai_test/
├── backend/                    # 后端服务
│   ├── main.py                 # FastAPI 应用入口
│   ├── agents/                 # AI 智能体（多 Agent 协作）
│   ├── workflow/               # LangGraph 工作流
│   │   ├── case_generator_workflow.py          # 功能用例生成工作流
│   │   ├── api_basecase_workflow.py            # 接口基础用例生成工作流
│   │   ├── api_case_generator_main_workflow.py # 接口用例生成主工作流
│   │   └── api_run_case_wrokflow.py            # 可执行用例生成工作流
│   ├── mcp_tools/              # AI Agent 工具集
│   ├── rag/                    # RAG 知识库管理
│   ├── api_case_run/           # 接口用例执行引擎
│   ├── config/                 # 配置与提示词
│   │   ├── settings.py         # 大模型配置
│   │   └── prompts/            # 各环节的 Prompt 模板
│   ├── service/                # 业务服务模块
│   │   ├── user/               # 用户管理
│   │   ├── project/            # 项目管理
│   │   ├── test_environment/   # 测试环境
│   │   ├── functional_test/    # 功能测试
│   │   ├── api_test/           # 接口测试
│   │   ├── test_management/    # 测试管理
│   │   └── test_execution/     # 测试执行
│   └── utils/                  # 工具类（认证、解析、权限等）
├── frontend/                   # 前端应用
│   └── src/
│       └── views/
│           ├── ApiTest/        # 接口测试（管理、用例、生成、执行）
│           ├── FunctionTest/   # 功能测试（需求、用例、AI 生成）
│           ├── UiTest/         # UI 自动化（开发中）
│           ├── ProjectSettings/# 项目设置
│           └── TestExecution/  # 测试执行报告
├── nginx/                      # Nginx 配置
├── docker-compose.yml          # Docker 编排
└── prd/                        # 示例需求文档
```

---

## 七、快速开始

### Docker 一键部署

```bash
cd ai/ai_test
docker-compose up -d --build
```

启动后访问：
- 前端页面：`http://localhost:5002`
- 接口文档：`http://localhost:5002/api/swagger`
- 默认管理员账号：`admin` / `123456`

### 本地开发

```bash
# 后端
cd backend
pip install -r requirements.txt
python main.py

# 前端
cd frontend
npm install
npm run dev
```

---

> **注意**：本项目的 UI 自动化执行能力及部分其他功能正在由团队其他成员同步开发中，本文档描述的是当前代码仓库中已实现的核心功能。
