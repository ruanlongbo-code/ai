from langchain_core.prompts import PromptTemplate

# 补充生成基础测试用例的提示词
prompt2 = PromptTemplate(
    input_variables=["api_doc", "preconditions", "coverage_report", "cases"],
    template="""
    你是一位资深的测试工程师，需要根据覆盖率分析报告的缺失项和已有用例，针对性地为接口补充生成缺失的测试用例。

    ## 任务要求：
    1. 严格根据**覆盖率分析报告**中的缺失项生成用例
    2. 每个测试用例只覆盖一个缺失的测试点
    3. 生成的用例必须符合原始接口规范
    4. 确保前置依赖接口调用顺序正确
    5. **关键优化**：避免与已有用例重复，确保补充用例与现有用例互补

    ## 接口背景信息：
    ### 目标接口文档：
    {api_doc}

    ### 前置依赖接口调用顺序：
    {preconditions}

    ## 已生成的测试用例（避免重复）：
    {cases}

    ## 覆盖率分析报告（需补充的缺失项）：
    {coverage_report}

    ## 补充生成规则：
    ### 智能差异化生成策略：
    1. **参数缺失类** → 检查现有用例是否已覆盖：
       - 为每个未覆盖的必填参数生成缺失用例
       - 示例名称："验证缺失[参数名]时的错误处理"

    2. **边界值缺失** → 日更参数说明中有涉及到边界值，则需要对比现有用例边界覆盖：
       - 下边界-1 (min-1) → 如未覆盖则生成
       - 上边界+1 (max+1) → 如未覆盖则生成
       - 空值/空字符串 → 如未覆盖则生成

    3. **格式错误类** → 生成现有用例未覆盖的格式：
       - 数字传字符串 → 如果现有用例只有类型错误但无格式错误
       - 日期传非法格式 → 如果现有用例无日期格式验证
       - 枚举值传非法值 → 如果现有用例无非法枚举值测试

    4. **安全验证类** → 如果接口调用前置条件是需要认证登录，则需要检查用例是否覆盖下面的情况：
       - 无Token访问 → 如果现有用例只有过期Token测试
       - 错误权限Token → 如果现有用例只有普通Token测试

    ## 差异化生成示例：
    ### 当现有用例已有"手机号长度边界"但缺少"格式校验"时：
    测试用例名称：验证手机号包含字母时的错误处理  
    测试步骤：  
        - 1. 调用登录接口获取有效token  
        - 2. 发起用户注册请求，手机号字段传"138abc1234"  
    预期结果：  
        - 1. 返回HTTP状态码400  
        - 2. 响应体包含错误码"INVALID_PHONE_FORMAT"  
    前置依赖数据的接口调用顺序：  
        - ["登录接口"]

    ### 当现有用例已有"正常Token"但缺少"错误权限Token"时：
    测试用例名称：验证普通用户Token访问管理员接口的权限错误  
    测试步骤：  
        - 1. 调用普通用户登录接口获取token  
        - 2. 使用该token访问管理员专属接口  
    预期结果：  
        - 1. 返回HTTP状态码403  
        - 2. 响应体包含错误码"PERMISSION_DENIED"  
    前置依赖数据的接口调用顺序：  
        - ["普通用户登录接口"]

    ## 关键检查点（生成后自检）：
    1. 补充用例是否解决了覆盖率报告中的具体缺失项
    2. 是否与现有用例有实质区别（非简单重复）
    3. 前置依赖是否与接口文档一致
    4. 是否每个用例只测试一个关注点

    请基于上述信息，为所有缺失项生成精准的差异化补充测试用例。


    ## 输出格式要求：必须输出json格式，无需多余的提示内容（必须遵循）
    **严格保持以下结构**，
    ```json
    [
      {{
        "name": "测试用例名称",
        "steps": [
          "步骤描述1",
          "步骤描述2"
        ],
        "expected": [
          "预期结果断言1",
          "预期结果断言2"
        ],
        "dependencies": ["依赖接口1", "依赖接口2"]
      }}
    ]
    ```
   
    """
)

# 补充生成基础测试用例的提示词（优化版）
prompt = PromptTemplate(
    input_variables=["api_doc", "preconditions", "coverage_report", "cases"],
    template="""
你是一位资深的测试工程师，需要根据覆盖率分析报告的缺失项和已有用例，为接口生成完整的缺失测试用例。

## 核心目标：
1. **必须为覆盖率报告中的每一个缺失项生成至少一个测试用例**。
2. 每个测试用例只覆盖一个缺失点。
3. 保证生成的测试用例符合接口文档规范。
4. 前置依赖接口调用顺序必须正确。
5. 保持与已有用例差异化，避免重复。

## 接口信息：
### 目标接口文档：
{api_doc}

### 前置依赖接口调用顺序：
{preconditions}

### 已生成的测试用例：
{cases}

### 覆盖率分析报告（缺失项）：
{coverage_report}

## 生成规则：
1. **遍历所有缺失项**：对报告中的每个缺失点生成至少一个用例。
2. **差异化原则**：生成的用例必须与现有用例在关键字段或数据上有所区别，但优先保证完整覆盖。
3. **类型与范围**：
   - 参数缺失 → 生成缺失必填参数的测试用例
   - 边界值 → 生成 min-1、max+1 或空值/空字符串的测试用例
   - 格式错误 → 生成非法格式、非法枚举等
   - 安全验证 → 无Token、过期Token或权限不足Token

## 输出格式要求：
- 必须严格输出 JSON 格式，无多余说明
- 严格遵循以下结构：
    ```json
    [
      {{
        "name": "测试用例名称",
        "steps": [
          "步骤描述1",
          "步骤描述2"
        ],
        "expected": [
          "预期结果断言1",
          "预期结果断言2"
        ],
        "dependencies": ["依赖接口1", "依赖接口2"]
      }}
    ]
"""
)
