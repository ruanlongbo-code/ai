# 服务，表示要启动的容器服务
services:
  # 每个服务的名字就是容器的名字
  # 拉取官方mysql镜像8.4.2版本
  mysql:
    image: mysql:8.4.2
    ports:
      - "9527:3306"
    restart: always
    container_name: py_mysql
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    environment:
      MYSQL_ROOT_PASSWORD: 123456py
      MYSQL_DATABASE: fastapi
    volumes:
      - mysql:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p123456py"]
      interval: 10s
      timeout: 5s
      retries: 5

  # 创建fastapi后端镜像
  backend:
    depends_on:
      mysql:
        condition: service_healthy
    build: ./backend
    image: py_backend
    container_name: py_backend
    restart: always
    environment:
      - DATA_BASE_HOST=mysql
      - DATA_BASE_PORT=3306
      - DATA_BASE_USER=root
      - DATA_BASE_PASSWORD=123456py
      - DATA_BASE_NAME=fastapi
    volumes:
      - backend_logs:/app/logs

  # 创建nginx镜像（包含前端构建）
  nginx:
    depends_on:
      - backend
    build:
      context: .
      dockerfile: nginx/Dockerfile
    image: py_nginx
    container_name: py_nginx
    ports:
      - "5001:80"
      - "5002:81"
    volumes:
      - nginx_logs:/var/log

# 全局声明
volumes:
  mysql:
  backend_logs:
  nginx_logs:
